------

## 文件系统的基本组成

文件系统是操作系统中负责管理**持久数据**的子系统。就是负责把用户的文件存到磁盘硬件中，因为即使计算机断电了，磁盘里的数据并不会丢失，可以持久化的保存文件。

文件系统的基本数据单位是文件，它的目的是对磁盘上的文件进行组织管理，那组织的方式不同，就会形成不同的文件系统。

Linux 最经典的一句话是：<font color=Blue>**一切皆文件**</font>，不仅普通的文件和目录，就连块设备、管道、socket 等，也都是统一交给文件系统管理的。

Linux 文件系统会为每个文件分配两个数据结构：**<font color=Blue>索引节点（<font style="color: rgb(255,20,147)">index node</font>）</font>**和<font color=Blue>**目录项（<font style="color: rgb(255,20,147)">directory entry</font>）**</font>，它们主要用来记录文件的元信息和目录层次结构。

- 索引节点，也就是 <font style="color: rgb(255,20,147)">inode</font>，用来**记录文件的元信息**，比如 inode 编号、文件大小、访问权限、创建时间、修改时间、数据在磁盘的位置等等。索引节点是文件的**唯一标识**，它们之间一一对应，也同样都会被**存储在硬盘中**，所以索引节点同样占用磁盘空间。

- 目录项，也就是 **dentry**，用来记录文件的名字、索引节点指针以及与其他目录项的层级关联关系。多个目录项关联起来，就会形成目录结构，但它与索引节点不同的是，目录项是由内核维护的一个数据结构，**不存放于磁盘，而是缓存在内存**。

由于索引节点唯一标识一个文件，而目录项记录着文件的名字，所以目录项和索引节点的关系是多对一，也就是说，一个文件可以有多个别名。比如，**硬链接**的实现就是多个目录项中的索引节点指向同一个文件。

注意，目录也是文件，也是用索引节点唯一标识。不同的是，普通文件在磁盘里面保存的是文件数据，而目录文件在磁盘里面保存子目录或文件。

> **硬链接和软链接？**

文件的硬链接是一个指向inode的目录项。硬链接从表面上来说就是一个文件，但是该文件是基于原始文件创建的链接文件。硬链接与源文件指向相同的inode，因此其数据也是完全一样的。

相对于硬链接，还有一个软链接的概念。软链接是指向一个具体的文件的，而非文件的inode，所以当文件重新命名时，软链接就会失效。因为该软链接原本指向的文件不存在了。而硬链接则不会存在这种情况。

硬链接可以看作是同一个文件的不同名称，它们共享同一个inode号和数据块，因此删除其中一个硬链接并不会影响其他硬链接和原始文件。只有删除文件的所有硬链接以及源文件时，系统才会彻底删除该文件，所以创建硬链接可以预防文件被误删。

> **目录项和目录是一个东西吗？**

不是同一个东西，**目录是个文件**，持久化存储在磁盘，而**目录项是内核一个数据结构**，缓存在内存。

如果查询目录频繁从磁盘读，效率会很低，所以内核会把已经读过的目录用目录项这个数据结构缓存在内存，下次再次读到相同的目录时，只需从内存读就可以，大大提高了文件系统的效率。

注意，目录项这个数据结构不只是表示目录，也是可以表示文件的。

> **那文件数据是如何存储在磁盘的呢？**

磁盘读写的最小单位是扇区，扇区的大小只有 512B 大小，很明显，如果每次读写都以这么小为单位，那这读写的效率会非常低。

所以，文件系统把多个扇区组成了一个逻辑块，每次读写的最小单位就是逻辑块（数据块），Linux 中的逻辑块大小为 4KB，也就是一次性读写 8 个扇区，这将大大提高了磁盘的读写的效率。

以上就是索引节点、目录项以及文件数据的关系，下面这个图就很好的展示了它们之间的关系：

<img src="../img/6/1.png" style="zoom:50%;" />

------

## 虚拟文件系统

- *内存的文件系统*，这类文件系统的数据不是存储在硬盘的，而是占用内存空间，我们经常用到的 的、`/proc` 和 `/sys` 文件系统都属于这一类，读写这类文件，实际上是读写内核中相关的数据。
